#!/bin/bash
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# Docker é•œåƒåç§° - æ”¹ä¸ºä½ çš„ Docker Hub ç”¨æˆ·å
DOCKER_IMAGE="your-dockerhub-username/caddy-naiveproxy:latest"

echo "========================================="
echo "  Caddy NaiveProxy äº¤äº’å¼éƒ¨ç½²è„šæœ¬"
echo "========================================="
echo ""

# äº¤äº’å¼è¾“å…¥é…ç½®å‚æ•°
read -p "è¯·è¾“å…¥åŸŸå (ä¾‹å¦‚: example.com): " domain
while [ -z "$domain" ]; do
    echo "âŒ åŸŸåä¸èƒ½ä¸ºç©ºï¼"
    read -p "è¯·è¾“å…¥åŸŸå: " domain
done

read -p "è¯·è¾“å…¥ä»£ç†è·¯å¾„ (ä¾‹å¦‚: mypath): " proxyPath
while [ -z "$proxyPath" ]; do
    echo "âŒ ä»£ç†è·¯å¾„ä¸èƒ½ä¸ºç©ºï¼"
    read -p "è¯·è¾“å…¥ä»£ç†è·¯å¾„: " proxyPath
done

read -p "è¯·è¾“å…¥ Cloudflare API Token: " cloudflareApiToken
while [ -z "$cloudflareApiToken" ]; do
    echo "âŒ API Token ä¸èƒ½ä¸ºç©ºï¼"
    read -p "è¯·è¾“å…¥ Cloudflare API Token: " cloudflareApiToken
done

read -p "è¯·è¾“å…¥ Naive ç”¨æˆ·å: " naive_user
while [ -z "$naive_user" ]; do
    echo "âŒ ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼"
    read -p "è¯·è¾“å…¥ Naive ç”¨æˆ·å: " naive_user
done

read -sp "è¯·è¾“å…¥ Naive å¯†ç : " naive_passwd
echo ""
while [ -z "$naive_passwd" ]; do
    echo "âŒ å¯†ç ä¸èƒ½ä¸ºç©ºï¼"
    read -sp "è¯·è¾“å…¥ Naive å¯†ç : " naive_passwd
    echo ""
done

echo ""
echo "========================================="
echo "é…ç½®ç¡®è®¤ï¼š"
echo "========================================="
echo "åŸŸå: ${domain}"
echo "ä»£ç†è·¯å¾„: /${proxyPath}"
echo "Cloudflare Token: ${cloudflareApiToken:0:20}..."
echo "Naive ç”¨æˆ·: ${naive_user}"
echo "Naive å¯†ç : ${naive_passwd:0:8}..."
echo "Docker é•œåƒ: ${DOCKER_IMAGE}"
echo "========================================="
echo ""

read -p "ç¡®è®¤é…ç½®æ— è¯¯ï¼Ÿ(y/n): " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "âŒ éƒ¨ç½²å·²å–æ¶ˆ"
    exit 0
fi

echo ""
echo "========================================="
echo "å¼€å§‹éƒ¨ç½² Caddy NaiveProxy æœåŠ¡"
echo "========================================="

# è®¾ç½®æ—¶åŒº
echo "â° è®¾ç½®æ—¶åŒº..."
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
echo "Asia/Shanghai" > /etc/timezone

# æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–
echo "ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
apt update && apt upgrade -y
apt install -y curl ca-certificates gnupg

# å®‰è£… Dockerï¼ˆå¦‚æžœæœªå®‰è£…ï¼‰
if ! command -v docker &> /dev/null; then
    echo "ðŸ³ å®‰è£… Docker..."
    curl -fsSL https://get.docker.com | sh
    systemctl enable docker
    systemctl start docker
else
    echo "âœ… Docker å·²å®‰è£…"
fi

# åŒæ­¥æ—¶é—´
echo "ðŸ• åŒæ­¥ç³»ç»Ÿæ—¶é—´..."
apt install -y ntpdate
ntpdate -u pool.ntp.org || ntpdate -u time.google.com

# åˆ›å»ºç›®å½•ç»“æž„
echo "ðŸ“ åˆ›å»ºç›®å½•..."
mkdir -p caddy/{data,config,logs}

# ç”Ÿæˆ Caddyfile
if [ ! -f "./caddy/Caddyfile" ]; then
    echo "ðŸ“ ç”Ÿæˆ Caddyfile..."
    cp Caddyfile.example ./caddy/Caddyfile
    sed -i "s/domain/${domain}/g" ./caddy/Caddyfile
    sed -i "s/proxyPath/${proxyPath}/g" ./caddy/Caddyfile
    sed -i "s/cloudflareApiToken/${cloudflareApiToken}/g" ./caddy/Caddyfile
    sed -i "s/naiveUser/${naive_user}/g" ./caddy/Caddyfile
    sed -i "s/naivePasswd/${naive_passwd}/g" ./caddy/Caddyfile
else
    echo "âš ï¸  Caddyfile å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ"
    read -p "æ˜¯å¦è¦†ç›–çŽ°æœ‰é…ç½®ï¼Ÿ(y/n): " overwrite
    if [ "$overwrite" = "y" ] || [ "$overwrite" = "Y" ]; then
        cp Caddyfile.example ./caddy/Caddyfile
        sed -i "s/domain/${domain}/g" ./caddy/Caddyfile
        sed -i "s/proxyPath/${proxyPath}/g" ./caddy/Caddyfile
        sed -i "s/cloudflareApiToken/${cloudflareApiToken}/g" ./caddy/Caddyfile
        sed -i "s/naiveUser/${naive_user}/g" ./caddy/Caddyfile
        sed -i "s/naivePasswd/${naive_passwd}/g" ./caddy/Caddyfile
        echo "âœ… Caddyfile å·²æ›´æ–°"
    fi
fi

# åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if docker ps -a --format '{{.Names}}' | grep -q "^caddy$"; then
    echo "ðŸ—‘ï¸  åˆ é™¤æ—§çš„ Caddy å®¹å™¨..."
    docker stop caddy 2>/dev/null || true
    docker rm caddy
fi

# å¯åŠ¨ Caddy å®¹å™¨
echo "ðŸš€ å¯åŠ¨ Caddy å®¹å™¨..."
docker run -d --name caddy \
    --restart=always \
    --net=host \
    --log-opt max-size=10m \
    --log-opt max-file=3 \
    -v $PWD/caddy/Caddyfile:/etc/caddy/Caddyfile:ro \
    -v $PWD/caddy/data:/data/caddy \
    -v $PWD/caddy/config:/config \
    -v $PWD/caddy/logs:/var/log/caddy \
    ${DOCKER_IMAGE}

# æ£€æŸ¥ Caddy å¯åŠ¨çŠ¶æ€
echo "â³ ç­‰å¾… Caddy å¯åŠ¨..."
sleep 5
if docker ps | grep -q caddy; then
    echo "âœ… Caddy å®¹å™¨å¯åŠ¨æˆåŠŸ"
    docker logs caddy --tail 20
else
    echo "âŒ Caddy å®¹å™¨å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
    docker logs caddy
    exit 1
fi

# å¯åŠ¨ Watchtower è‡ªåŠ¨æ›´æ–°
if ! docker ps -a --format '{{.Names}}' | grep -q "^watchtower$"; then
    echo "ðŸ”„ å¯åŠ¨ Watchtower è‡ªåŠ¨æ›´æ–°..."
    docker run -d --name watchtower \
        --restart=unless-stopped \
        -v /var/run/docker.sock:/var/run/docker.sock \
        containrrr/watchtower --cleanup --interval 21600
else
    echo "âœ… Watchtower å·²åœ¨è¿è¡Œ"
fi

# å¼€å¯ BBR å’Œæ€§èƒ½ä¼˜åŒ–
echo "ðŸš„ é…ç½®ç½‘ç»œæ€§èƒ½ä¼˜åŒ–..."
modprobe tcp_bbr 2>/dev/null || echo "âš ï¸  BBR æ¨¡å—åŠ è½½å¤±è´¥"

# æ£€æŸ¥ sysctl.conf æ˜¯å¦å·²åŒ…å«é…ç½®ï¼Œé¿å…é‡å¤æ·»åŠ 
if ! grep -q "# BBR åŠ é€Ÿ" /etc/sysctl.conf; then
cat >> /etc/sysctl.conf << EOF

# BBR åŠ é€Ÿ
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr

# TCP æ€§èƒ½ä¼˜åŒ–
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_slow_start_after_idle=0
net.ipv4.tcp_mtu_probing=1
net.ipv4.tcp_notsent_lowat=16384

# è¿žæŽ¥é˜Ÿåˆ—ä¼˜åŒ–
net.core.somaxconn=65535
net.ipv4.tcp_max_syn_backlog=8192
net.core.netdev_max_backlog=16384

# å¤§ç¼“å†²åŒº - æå‡é«˜å¸¦å®½æ€§èƒ½
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864
net.ipv4.tcp_mem=786432 1048576 26777216

# TIME_WAIT å¿«é€Ÿå›žæ”¶
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_fin_timeout=15

# ä¿æŒè¿žæŽ¥æ´»è·ƒ
net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_intvl=10
net.ipv4.tcp_keepalive_probes=3

# IP è½¬å‘ï¼ˆå¦‚æžœéœ€è¦ï¼‰
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
EOF
else
    echo "âš ï¸  ç½‘ç»œä¼˜åŒ–é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
fi

sysctl -p > /dev/null

# éªŒè¯ä¼˜åŒ–
echo "âœ… ç½‘ç»œä¼˜åŒ–å·²åº”ç”¨"
sysctl net.ipv4.tcp_congestion_control
sysctl net.ipv4.tcp_fastopen

# ç¦ç”¨ç³»ç»Ÿé˜²ç«å¢™ï¼ˆä½¿ç”¨äº‘é˜²ç«å¢™ï¼‰
echo "ðŸ”¥ ç¦ç”¨ç³»ç»Ÿé˜²ç«å¢™..."
if command -v ufw &> /dev/null; then
    ufw --force disable
    systemctl disable ufw 2>/dev/null || true
    echo "âœ… UFW é˜²ç«å¢™å·²ç¦ç”¨"
fi

if command -v firewalld &> /dev/null; then
    systemctl stop firewalld 2>/dev/null || true
    systemctl disable firewalld 2>/dev/null || true
    echo "âœ… Firewalld å·²ç¦ç”¨"
fi

# æ¸…ç†å¯èƒ½å­˜åœ¨çš„ iptables è§„åˆ™
iptables -F
iptables -X
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
echo "âœ… iptables è§„åˆ™å·²æ¸…ç©º"

# ä¿å­˜é…ç½®åˆ°æ–‡ä»¶ï¼ˆæ–¹ä¾¿åŽç»­æŸ¥çœ‹ï¼‰
cat > ./caddy/config.txt << EOF
éƒ¨ç½²æ—¶é—´: $(date)
åŸŸå: ${domain}
ä»£ç†è·¯å¾„: /${proxyPath}
Naive ç”¨æˆ·: ${naive_user}
Naive å¯†ç : ${naive_passwd}
Cloudflare Token: ${cloudflareApiToken}
EOF
chmod 600 ./caddy/config.txt

echo ""
echo "========================================="
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "========================================="
echo "åŸŸå: ${domain}"
echo "ä»£ç†è·¯å¾„: /${proxyPath}"
echo "Naive ç”¨æˆ·: ${naive_user}"
echo "Naive å¯†ç : ${naive_passwd}"
echo ""
echo "âš ï¸  é…ç½®å·²ä¿å­˜åˆ°: ./caddy/config.txt"
echo ""
echo "âš ï¸  è¯·åœ¨äº‘æœåŠ¡å•†æŽ§åˆ¶å°é…ç½®å®‰å…¨ç»„ï¼š"
echo "   - å¼€æ”¾ 22/tcp  (SSH)"
echo "   - å¼€æ”¾ 80/tcp  (HTTP)"
echo "   - å¼€æ”¾ 443/tcp (HTTPS)"
echo ""
echo "ðŸ“Š æŸ¥çœ‹æ—¥å¿—: docker logs -f caddy"
echo "ðŸ” æ£€æŸ¥çŠ¶æ€: docker ps"
echo "ðŸ›‘ åœæ­¢æœåŠ¡: docker stop caddy"
echo "ðŸ”„ é‡å¯æœåŠ¡: docker restart caddy"
echo "========================================="
